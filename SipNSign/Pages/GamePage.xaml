<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewmodels="clr-namespace:com.kizwiz.sipnsign.ViewModels"
    xmlns:converters="clr-namespace:com.kizwiz.sipnsign.Converters"
    xmlns:models="clr-namespace:com.kizwiz.sipnsign.Models"
    x:Class="com.kizwiz.sipnsign.Pages.GamePage"
    x:DataType="viewmodels:GameViewModel"
    Style="{StaticResource AppPageStyle}"
    Title="{Binding ModeTitle}">

    <!-- Page Resources -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:PlayerAnswerConverter x:Key="PlayerAnswerConverter"/>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>

            <!-- Add new converters for visual indicators -->
            <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
            <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
            <converters:BoolToButtonColorConverter x:Key="BoolToButtonColorConverter"/>

            <Style x:Key="ScoreStyle" TargetType="Label">
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="FontSize" Value="18"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="Margin" Value="0"/>
                <Setter Property="Padding" Value="0"/>
            </Style>

            <!-- Answer button styles (smaller / shorter buttons) -->
            <Style x:Key="AnswerButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontSize" Value="15" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="Padding" Value="6" />
                <Setter Property="Margin" Value="4" />
                <!-- make buttons shorter by limiting width; horizontal centering keeps layout tidy -->
                <Setter Property="WidthRequest" Value="140" />
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Style.Triggers>
                    <Trigger TargetType="Button" Property="IsPressed" Value="True">
                        <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryDark}" />
                    </Trigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="PlayerAnswerButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="Padding" Value="6" />
                <Setter Property="Margin" Value="2" />
                <Setter Property="WidthRequest" Value="40" />
                <Setter Property="HeightRequest" Value="40" />
                <Style.Triggers>
                    <Trigger TargetType="Button" Property="IsPressed" Value="True">
                        <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryDark}" />
                    </Trigger>
                </Style.Triggers>
            </Style>

        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top Section -->
        <Grid Grid.Row="0" Padding="20,10" ColumnDefinitions="*,Auto">
            <!-- Progress Bar -->
            <Grid>
                <ProgressBar x:Name="GameProgress"
                             Style="{StaticResource ProgressBarStyle}"
                             Progress="{Binding ProgressPercentage}"/>

                <!-- Timer Display -->
                <Border 
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        BackgroundColor="{DynamicResource Primary}"
                        StrokeShape="RoundRectangle 15"
                        Padding="10,2"
                        Opacity="0.9">
                    <Label 
                        Text="{Binding RemainingTime}"
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        FontSize="20"
                        FontAttributes="Bold"
                        TextColor="White">
                        <Label.Shadow>
                            <Shadow 
                                Brush="Black"
                                Offset="0,1"
                                Radius="2"
                                Opacity="0.5"/>
                        </Label.Shadow>
                        <Label.Triggers>
                            <DataTrigger TargetType="Label"
                                Binding="{Binding RemainingTime}"
                                Value="0">
                                <Setter Property="Text" Value="âˆž"/>
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                </Border>
            </Grid>

            <!-- Score display - Single player version -->
            <Border Grid.Column="1" 
                   Padding="15,5"
                   Background="{DynamicResource Primary}"
                   StrokeShape="RoundRectangle 20"
                   IsVisible="{Binding IsMultiplayer, Converter={StaticResource InverseBoolConverter}}">
                <Label Style="{StaticResource ScoreStyle}"
                        Text="{Binding CurrentScore, StringFormat='Score: {0}'}"/>
            </Border>

            <!-- Scoreboard Button - Multiplayer version -->
            <Border Grid.Column="1" 
                   Padding="15,5"
                   Background="{DynamicResource Primary}"
                   StrokeShape="RoundRectangle 20"
                   IsVisible="{Binding IsMultiplayer}">
                <StackLayout Orientation="Horizontal" Spacing="5">
                    <Label Text="Scores" 
               Style="{StaticResource ScoreStyle}"/>
                    <Label Text="ðŸ‘¥" 
               FontSize="18" 
               TextColor="White" 
               VerticalOptions="Center"/>
                </StackLayout>

                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ShowScoreboardCommand}"/>
                </Border.GestureRecognizers>
            </Border>
        </Grid>

        <!-- Guess Mode -->
        <Grid Grid.Row="1" IsVisible="{Binding IsGuessMode}">
            <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="12" RowSpacing="8">
                <!-- Row 0: Video container -->
                <Border Grid.Row="0"
                Padding="0"
                Stroke="{DynamicResource Primary}"
                StrokeThickness="1"
                Background="Black"
                StrokeShape="RoundRectangle 15"
                HeightRequest="360">
                    <Border.Triggers>
                        <!-- Reduce frame height when in multiplayer -->
                        <DataTrigger TargetType="Border" Binding="{Binding IsMultiplayer}" Value="True">
                            <Setter Property="HeightRequest" Value="300" />
                        </DataTrigger>
                    </Border.Triggers>

                    <Grid>
                        <!-- Single-player video -->
                        <toolkit:MediaElement
            x:Name="SharedVideo"
            Source="{Binding CurrentVideoSource}"
            ShouldShowPlaybackControls="False"
            ShouldAutoPlay="True"
            ShouldLoopPlayback="True"
            Aspect="AspectFit"
            HeightRequest="320"
            WidthRequest="320"
            HorizontalOptions="Center"
            VerticalOptions="Center"
            MediaOpened="OnMediaOpened"
            MediaFailed="OnMediaFailed"
            MediaEnded="OnMediaEnded"
            Volume="0"
            ShouldMute="True"
            IsVisible="{Binding IsMultiplayer, Converter={StaticResource InverseBoolConverter}}"/>

                        <!-- Multiplayer video reduced visually by outer Border Trigger -->
                        <toolkit:MediaElement
            x:Name="MultiplayerGuessVideo"
            Source="{Binding CurrentVideoSource}"
            ShouldShowPlaybackControls="False"
            ShouldAutoPlay="True"
            ShouldLoopPlayback="True"
            Aspect="AspectFit"
            HeightRequest="260"
            WidthRequest="320"
            HorizontalOptions="Center"
            VerticalOptions="Center"
            MediaOpened="OnMediaOpened"
            MediaFailed="OnMediaFailed"
            MediaEnded="OnMediaEnded"
            Volume="0"
            ShouldMute="True"
            IsVisible="{Binding IsMultiplayer}"/>

                        <!-- Feedback Overlay for Guess Mode -->
                        <Border IsVisible="{Binding IsFeedbackVisible}"
                                StrokeShape="RoundRectangle 20"
                                Margin="20,40"
                                VerticalOptions="Center"
                                HorizontalOptions="Center"
                                ZIndex="10"
                                InputTransparent="False">
                            <Border.Background>
                                <SolidColorBrush Color="{Binding FeedbackBackgroundColor}"/>
                            </Border.Background>
                            <VerticalStackLayout Spacing="10" Padding="20">
                                <Label Text="{Binding FeedbackText}"
                                       TextColor="White"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>
                </Border>

                <!-- Row 1: Single-player answers (2 per row) - slightly less vertical gap -->
                <Grid Grid.Row="1"
      IsVisible="{Binding IsMultiplayer, Converter={StaticResource InverseBoolConverter}}"
      ColumnDefinitions="*,*"
      RowDefinitions="Auto,Auto"
      ColumnSpacing="8"
      RowSpacing="6"
      Margin="0,6,0,0">
                    <Button Grid.Row="0" Grid.Column="0"
                    Style="{StaticResource AnswerButton}"
                    Text="{Binding CurrentSign.Choices[0]}"
                    Command="{Binding AnswerCommand}"
                    CommandParameter="{Binding CurrentSign.Choices[0]}"
                    BackgroundColor="{Binding Button1Color}"
                    HorizontalOptions="Fill"/>
                    <Button Grid.Row="0" Grid.Column="1"
                    Style="{StaticResource AnswerButton}"
                    Text="{Binding CurrentSign.Choices[1]}"
                    Command="{Binding AnswerCommand}"
                    CommandParameter="{Binding CurrentSign.Choices[1]}"
                    BackgroundColor="{Binding Button2Color}"
                    HorizontalOptions="Fill"/>
                    <Button Grid.Row="1" Grid.Column="0"
                    Style="{StaticResource AnswerButton}"
                    Text="{Binding CurrentSign.Choices[2]}"
                    Command="{Binding AnswerCommand}"
                    CommandParameter="{Binding CurrentSign.Choices[2]}"
                    BackgroundColor="{Binding Button3Color}"
                    HorizontalOptions="Fill"/>
                    <Button Grid.Row="1" Grid.Column="1"
                    Style="{StaticResource AnswerButton}"
                    Text="{Binding CurrentSign.Choices[3]}"
                    Command="{Binding AnswerCommand}"
                    CommandParameter="{Binding CurrentSign.Choices[3]}"
                    BackgroundColor="{Binding Button4Color}"
                    HorizontalOptions="Fill"/>
                </Grid>

                <!-- Row 2: Multiplayer area -->
                <Grid Grid.Row="2" IsVisible="{Binding IsMultiplayer}" RowDefinitions="Auto,*,Auto" VerticalOptions="FillAndExpand">
                    <!-- Legend -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" RowSpacing="8" ColumnSpacing="8" Margin="0,0,0,6">
                        <Button Grid.Row="0" Grid.Column="0" Style="{StaticResource AnswerButton}" IsEnabled="False" Text="{Binding CurrentSign.Choices[0], StringFormat='1. {0}'}"/>
                        <Button Grid.Row="0" Grid.Column="1" Style="{StaticResource AnswerButton}" IsEnabled="False" Text="{Binding CurrentSign.Choices[1], StringFormat='2. {0}'}"/>
                        <Button Grid.Row="1" Grid.Column="0" Style="{StaticResource AnswerButton}" IsEnabled="False" Text="{Binding CurrentSign.Choices[2], StringFormat='3. {0}'}"/>
                        <Button Grid.Row="1" Grid.Column="1" Style="{StaticResource AnswerButton}" IsEnabled="False" Text="{Binding CurrentSign.Choices[3], StringFormat='4. {0}'}"/>
                    </Grid>

                    <!-- Players list: CollectionView in star row; reduce bottom margin -->
                    <CollectionView Grid.Row="1"
                           ItemsSource="{Binding Players}"
                           ItemsLayout="VerticalList"
                           SelectionMode="None"
                           VerticalOptions="FillAndExpand"
                           Margin="0,0,0,4">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Player">
                                <Grid Padding="10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Label Text="{Binding Name}" FontSize="18" VerticalOptions="Center" TextColor="White"/>

                                    <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="6" VerticalOptions="Center">
                                        <Button Text="1" Clicked="OnPlayerGuessAnswerClicked" ClassId="{Binding Name}" CommandParameter="1" Style="{StaticResource PlayerAnswerButton}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding SelectedAnswer}" Value="1">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryDark}" />
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>

                                        <Button Text="2" Clicked="OnPlayerGuessAnswerClicked" ClassId="{Binding Name}" CommandParameter="2" Style="{StaticResource PlayerAnswerButton}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding SelectedAnswer}" Value="2">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryDark}" />
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>

                                        <Button Text="3" Clicked="OnPlayerGuessAnswerClicked" ClassId="{Binding Name}" CommandParameter="3" Style="{StaticResource PlayerAnswerButton}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding SelectedAnswer}" Value="3">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryDark}" />
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>

                                        <Button Text="4" Clicked="OnPlayerGuessAnswerClicked" ClassId="{Binding Name}" CommandParameter="4" Style="{StaticResource PlayerAnswerButton}">
                                            <Button.Triggers>
                                                <DataTrigger TargetType="Button" Binding="{Binding SelectedAnswer}" Value="4">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryDark}" />
                                                </DataTrigger>
                                            </Button.Triggers>
                                        </Button>
                                    </StackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Confirm button: use the new code-behind Clicked handler so we always get the "who's missing" popup. -->
                    <Button Grid.Row="2"
                            Text="Confirm Answers"
                            Command="{Binding ConfirmGuessAnswersCommand}"
                            Clicked="OnConfirmGuessClicked"
                            IsEnabled="{Binding HasAllPlayersAnswered}"
                            TextColor="White"
                            Padding="10"
                            CornerRadius="10"
                            Style="{StaticResource PrimaryButton}">
                        <Button.Triggers>
                            <!-- Enabled state: visible, primary color -->
                            <DataTrigger TargetType="Button" Binding="{Binding HasAllPlayersAnswered}" Value="True">
                                <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                                <Setter Property="Opacity" Value="1.0" />
                            </DataTrigger>

                            <!-- Disabled state: greyed and semi-transparent -->
                            <DataTrigger TargetType="Button" Binding="{Binding HasAllPlayersAnswered}" Value="False">
                                <Setter Property="BackgroundColor" Value="{DynamicResource Gray300}" />
                                <Setter Property="Opacity" Value="0.6" />
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                </Grid>
            </Grid>
        </Grid>

        <!-- Perform Mode -->
        <Grid Grid.Row="1" IsVisible="{Binding IsPerformMode}">
            <!-- Single Player Mode - No scrolling -->
            <Grid IsVisible="{Binding IsMultiplayer, Converter={StaticResource InverseBoolConverter}}">
                <VerticalStackLayout Padding="15" Spacing="15">
                    <Label Text="Can you sign this word?"
                   FontSize="20"
                   TextColor="White"
                   Margin="0,-5,0,0"
                   HorizontalOptions="Center"/>
                    <Label Text="{Binding CurrentSign.CorrectAnswer}"
                   FontSize="46"
                   TextColor="White"
                   Margin="0,-5,0,15"
                   HorizontalOptions="Center"
                   FontAttributes="Bold"/>

                    <!-- Reveal button -->
                    <Button Text="REVEAL SIGN"
                    Command="{Binding RevealSignCommand}"
                    Style="{StaticResource PrimaryButton}"
                    IsVisible="{Binding IsSignHidden}"
                    Margin="0,0,0,10"/>

                    <!-- Video and response buttons with feedback overlay in a grid -->
                    <Grid IsVisible="{Binding IsSignRevealed}"
                        HeightRequest="340"
                          Margin="0,10,0,15">
                        <!-- Container for video -->
                        <Border Padding="1"
                                Stroke="{DynamicResource Primary}"
                                StrokeThickness="1"
                                Background="Black"
                                StrokeShape="RoundRectangle 10"
                                Margin="0,0"
                                HeightRequest="400">
                            <!-- Increased from 300 -->
                            <toolkit:MediaElement 
                                x:Name="PerformVideo"
                                ShouldShowPlaybackControls="False"
                                ShouldAutoPlay="True"
                                ShouldLoopPlayback="True"
                                HeightRequest="400"   
                                WidthRequest="320"
                                
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                Aspect="AspectFit"
                                MediaOpened="OnMediaOpened"
                                MediaFailed="OnMediaFailed"
                                MediaEnded="OnMediaEnded"
                                Volume="0"
                                ShouldMute="True"
                                IsVisible="{Binding IsSignRevealed}"/>
                        </Border>

                        <!-- Feedback Overlay -->
                        <Border IsVisible="{Binding IsFeedbackVisible}"
                        StrokeShape="RoundRectangle 20"
                        Margin="20,40"
                        VerticalOptions="Center"
                        HorizontalOptions="Center"
                        ZIndex="10">
                            <Border.Background>
                                <SolidColorBrush Color="{Binding FeedbackBackgroundColor}"/>
                            </Border.Background>
                            <VerticalStackLayout Spacing="10" Padding="20">
                                <Label Text="{Binding FeedbackText}"
                               TextColor="White"
                               FontSize="24"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- Response Buttons - Single Player -->
                    <StackLayout IsVisible="{Binding IsSignRevealed}"
             Spacing="12"
             Margin="0,15,0,0">
                        <Button Text="I GOT IT RIGHT!"
            Command="{Binding CorrectPerformCommand}"
            Style="{StaticResource PrimaryButton}"
            Margin="0,0,0,5"/>
                        <Button Text="I NEED A SIP..."
            Command="{Binding IncorrectPerformCommand}"
            Style="{StaticResource PrimaryButton}"
            Margin="0,0,0,0"/>
                    </StackLayout>
                </VerticalStackLayout>
            </Grid>

            <!-- Multiplayer Mode - Scrollable -->
            <ScrollView x:Name="MultiplayerScrollView"
            IsVisible="{Binding IsMultiplayer}"
            VerticalScrollBarVisibility="Always">
                <VerticalStackLayout Padding="15" Spacing="15">
                    <Label Text="Who can sign this word?"
               FontSize="20"
               TextColor="White"
               Margin="0,-5,0,0"
               HorizontalOptions="Center"/>
                    <Label Text="{Binding CurrentSign.CorrectAnswer}"
               FontSize="46"
               TextColor="White"
               Margin="0,-5,0,15"
               HorizontalOptions="Center"
               FontAttributes="Bold"/>

                    <!-- Reveal button -->
                    <Button Text="REVEAL SIGN"
                    Command="{Binding RevealSignCommand}"
                    Style="{StaticResource PrimaryButton}"
                    IsVisible="{Binding IsSignHidden}"
                    Margin="0,0,0,10"/>

                    <!-- Video and response buttons with feedback overlay in a grid -->
                    <Grid IsVisible="{Binding IsSignRevealed}"
                  HeightRequest="340"
                          Margin="0,10,0,15">
                        <!-- Container for video -->
                        <Border Padding="1"
        Stroke="{DynamicResource Primary}"
        StrokeThickness="1"
        Background="Black"
        StrokeShape="RoundRectangle 10"
        Margin="0,0"
        HeightRequest="400">
                            <!-- Increased from 300 -->
                            <toolkit:MediaElement 
        x:Name="MultiplayerPerformVideo"
        ShouldShowPlaybackControls="False"
        ShouldAutoPlay="True"
        ShouldLoopPlayback="True"
        HeightRequest="400"   
        WidthRequest="320"
        HorizontalOptions="Center"
        VerticalOptions="Center"
        Aspect="AspectFit"
        MediaOpened="OnMediaOpened"
        MediaFailed="OnMediaFailed"
        MediaEnded="OnMediaEnded"
        Volume="0"
        ShouldMute="True"
        IsVisible="{Binding IsSignRevealed}"/>
                        </Border>

                        <!-- Feedback Overlay with visual indicator -->
                        <Border IsVisible="{Binding IsFeedbackVisible}"
                        StrokeShape="RoundRectangle 20"
                        Margin="20,40"
                        VerticalOptions="Center"
                        HorizontalOptions="Center"
                        ZIndex="10">
                            <Border.Background>
                                <SolidColorBrush Color="{Binding FeedbackBackgroundColor}"/>
                            </Border.Background>
                            <VerticalStackLayout Spacing="10" Padding="20">
                                <Label Text="{Binding FeedbackText}"
                               TextColor="White"
                               FontSize="24"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- Multiplayer Player Selection and Response -->
                    <StackLayout IsVisible="{Binding IsSignRevealed}" Spacing="15"
                                 Margin="0,15,0,0">
                        <Label Text="{Binding PlayerResultsText}"
                               TextColor="White"
                               HorizontalOptions="Center"
                               FontSize="16"/>

                        <!-- Players List -->
                        <StackLayout BindableLayout.ItemsSource="{Binding Players}" Spacing="10" Margin="0,5">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:Player">
                                    <Border BackgroundColor="{DynamicResource CardBackground}"
                                            StrokeShape="RoundRectangle 10"
                                            Padding="5"
                                            Opacity="0.9">
                                        <Grid ColumnDefinitions="2*,*,*" Padding="5">
                                            <!-- Player Name with status indicator -->
                                            <StackLayout Grid.Column="0" Orientation="Horizontal" VerticalOptions="Center">
                                                <Ellipse Fill="{Binding IndicatorColor}"
                                                         WidthRequest="12"
                                                         HeightRequest="12"
                                                         Margin="0,0,8,0"
                                                         VerticalOptions="Center"/>
                                                <Label Text="{Binding Name}"
                                                       TextColor="White"
                                                       FontSize="18"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>
                                            </StackLayout>

                                            <!-- Correct Button - Always enabled, allows changing answers -->
                                            <Button Grid.Column="1"
                                                    Text="âœ“"
                                                    BackgroundColor="ForestGreen"
                                                    TextColor="White"
                                                    FontSize="18"
                                                    WidthRequest="45"
                                                    HeightRequest="45"
                                                    Margin="3,0"
                                                    Clicked="OnPlayerCorrectClicked"
                                                    ClassId="{Binding Name}"/>

                                            <!-- Incorrect Button - Always enabled, allows changing answers -->
                                            <Button Grid.Column="2"
                                                    Text="âœ—"
                                                    BackgroundColor="Crimson"
                                                    TextColor="White"
                                                    FontSize="18"
                                                    WidthRequest="45"
                                                    HeightRequest="45"
                                                    Clicked="OnPlayerIncorrectClicked"
                                                    ClassId="{Binding Name}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </StackLayout>

                        <Button Text="CONFIRM RESULTS"
                                Command="{Binding ConfirmResultsCommand}"
                                Style="{StaticResource PrimaryButton}"
                                BackgroundColor="{Binding HasAllPlayersAnswered, Converter={StaticResource BoolToButtonColorConverter}}"
                                IsEnabled="{Binding HasAllPlayersAnswered}"
                                Margin="0,20,0,5"/>
                    </StackLayout>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>

        <!-- Game Over Screen Overlay -->
        <Grid IsVisible="{Binding IsGameOver}" 
              InputTransparent="False" 
              ZIndex="99"
              Grid.RowSpan="3">
            <!-- Theme background gradient -->
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="{DynamicResource AppBackground1}" Offset="0.0" />
                    <GradientStop Color="{DynamicResource AppBackground2}" Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>

            <!-- Game Over card -->
            <Border Margin="20"
                    BackgroundColor="{DynamicResource CardBackground}"
                    Opacity="0.95"
                    VerticalOptions="Center"
                    HorizontalOptions="Fill"
                    StrokeShape="RoundRectangle 20">
                <VerticalStackLayout Spacing="20" Padding="20">
                    <Label Text="Game Over!"
                           TextColor="{DynamicResource CardText}"
                           FontSize="32"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"/>

                    <Label Text="{Binding GuessResults}"
                           TextColor="{DynamicResource CardText}"
                           FontSize="24"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"/>

                    <!-- Leaderboard for Multiplayer -->
                    <VerticalStackLayout IsVisible="{Binding IsMultiplayer}" Spacing="15">
                        <Label Text="Final Scores"
                               TextColor="{DynamicResource CardText}"
                               FontSize="24"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"/>

                        <CollectionView ItemsSource="{Binding Players}"
                                        HeightRequest="150">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Player">
                                    <Grid ColumnDefinitions="Auto,*,Auto" Padding="10">
                                        <Label Text="â­" 
                                               IsVisible="{Binding IsMainPlayer}"
                                               TextColor="Gold"
                                               FontSize="24"
                                               VerticalOptions="Center"/>

                                        <Label Grid.Column="1"
                                               Text="{Binding Name}"
                                               TextColor="{DynamicResource CardText}"
                                               FontSize="20"
                                               VerticalOptions="Center"/>

                                        <Label Grid.Column="2"
                                               Text="{Binding Score}"
                                               TextColor="{DynamicResource CardText}"
                                               FontSize="24"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <Button Text="Play Again"
                            Command="{Binding PlayAgainCommand}"
                            Style="{StaticResource PrimaryButton}"/>

                    <Button Text="Adjust Questions in Settings"
                            Command="{Binding GoToSettingsCommand}"
                            Style="{StaticResource PrimaryButton}"
                            FontSize="14"/>
                </VerticalStackLayout>
            </Border>
        </Grid>
    </Grid>
</ContentPage>