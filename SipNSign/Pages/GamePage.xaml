<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewmodels="clr-namespace:com.kizwiz.sipnsign.ViewModels"
    x:Class="com.kizwiz.sipnsign.Pages.GamePage"
    x:DataType="viewmodels:GameViewModel"
    Style="{StaticResource AppPageStyle}"
    Title="{Binding CurrentMode, StringFormat='{0} Mode'}">

    <!-- Page Resources -->
    <ContentPage.Resources>
        <Style x:Key="ScoreStyle" TargetType="Label">
            <Setter Property="TextColor" Value="White"/>
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="VerticalOptions" Value="Center"/>
            <Setter Property="HorizontalOptions" Value="Center"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Padding" Value="0"/>
        </Style>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top Section -->
        <Grid Grid.Row="0" Padding="20,10" ColumnDefinitions="*,Auto">
            <!-- Progress Bar -->
            <Grid>
                <ProgressBar x:Name="GameProgress"
                             Style="{StaticResource ProgressBarStyle}"
                             Progress="{Binding ProgressPercentage}"/>
                <Label Text="{Binding RemainingTime}"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       FontSize="16"
                       TextColor="{DynamicResource Primary}"
                       IsVisible="{Binding IsTimerEnabled}">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label"
                                     Binding="{Binding RemainingTime}"
                                     Value="0">
                            <Setter Property="Text" Value="âˆž"/>
                        </DataTrigger>
                    </Label.Triggers>
                </Label>
            </Grid>

            <!-- Score -->
            <Border Grid.Column="1" 
                   Padding="15,5"
                   Background="{DynamicResource Primary}"
                   StrokeShape="RoundRectangle 20">
                <Label Style="{StaticResource ScoreStyle}"
                       Text="{Binding CurrentScore, StringFormat='Score: {0}'}"/>
            </Border>
        </Grid>

        <!-- Guess Mode -->
        <Grid Grid.Row="1" IsVisible="{Binding IsGuessMode}">
            <VerticalStackLayout Padding="20" Spacing="15">
                <!-- Video container with feedback overlay -->
                <Grid>
                    <Border Padding="0"
                   Stroke="{DynamicResource Primary}"
                   StrokeThickness="1"
                   Background="Black"
                   StrokeShape="RoundRectangle 15"
                   HeightRequest="300">
                        <toolkit:MediaElement 
                    x:Name="SharedVideo"
                    ShouldShowPlaybackControls="False"
                    ShouldAutoPlay="True"
                    ShouldLoopPlayback="True"
                    Aspect="AspectFit"
                    HeightRequest="300"
                    WidthRequest="300"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    MediaOpened="OnMediaOpened"
                    MediaFailed="OnMediaFailed"
                    MediaEnded="OnMediaEnded"
                    Volume="1"
                    IsVisible="True"/>
                    </Border>

                    <!-- Feedback Overlay -->
                    <Border IsVisible="{Binding IsFeedbackVisible}"
                        StrokeShape="RoundRectangle 20"
                        Margin="20,0"
                        VerticalOptions="Center">
                        <Border.Background>
                            <SolidColorBrush Color="{Binding FeedbackBackgroundColor}"/>
                        </Border.Background>
                        <Label Text="{Binding FeedbackText}"
                           TextColor="White"
                           FontSize="24"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"
                           Padding="20"/>
                    </Border>
                </Grid>

                <!-- Buttons -->
                <Grid Grid.Row="2" ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" RowSpacing="10" ColumnSpacing="8">
                    <Button Grid.Column="0" Grid.Row="0"
                        Style="{StaticResource PrimaryButton}"
                        Text="{Binding CurrentSign.Choices[0]}"
                        Command="{Binding AnswerCommand}"
                        CommandParameter="{Binding CurrentSign.Choices[0]}"
                        BackgroundColor="{Binding Button1Color}"/>
                    <Button Grid.Column="1" Grid.Row="0"
                        Style="{StaticResource PrimaryButton}"
                        Text="{Binding CurrentSign.Choices[1]}"
                        Command="{Binding AnswerCommand}"
                        CommandParameter="{Binding CurrentSign.Choices[1]}"
                        BackgroundColor="{Binding Button2Color}"/>
                    <Button Grid.Column="0" Grid.Row="1"
                        Style="{StaticResource PrimaryButton}"
                        Text="{Binding CurrentSign.Choices[2]}"
                        Command="{Binding AnswerCommand}"
                        CommandParameter="{Binding CurrentSign.Choices[2]}"
                        BackgroundColor="{Binding Button3Color}"/>
                    <Button Grid.Column="1" Grid.Row="1"
                        Style="{StaticResource PrimaryButton}"
                        Text="{Binding CurrentSign.Choices[3]}"
                        Command="{Binding AnswerCommand}"
                        CommandParameter="{Binding CurrentSign.Choices[3]}"
                        BackgroundColor="{Binding Button4Color}"/>
                </Grid>
            </VerticalStackLayout>
        </Grid>

        <!-- Perform Mode -->
        <Grid Grid.Row="1" IsVisible="{Binding IsPerformMode}">
            <ScrollView>
                <VerticalStackLayout Padding="15" Spacing="8">
                    <Label Text="Can you sign this word?"
                   FontSize="20"
                   TextColor="White"
                   HorizontalOptions="Center"/>
                    <Label Text="{Binding CurrentSign.CorrectAnswer}"
                   FontSize="46"
                   TextColor="White"
                   HorizontalOptions="Center"
                   FontAttributes="Bold"/>

                    <!-- Reveal button -->
                    <Button Text="REVEAL SIGN"
                    Command="{Binding RevealSignCommand}"
                    Style="{StaticResource PrimaryButton}"
                    IsVisible="{Binding IsSignHidden}"
                    Margin="0,10,0,5"/>

                    <!-- Video and response buttons -->
                    <StackLayout IsVisible="{Binding IsSignRevealed}">
                        <Grid>
                            <Border Padding="1"
                           Stroke="{DynamicResource Primary}"
                           StrokeThickness="1"
                           Background="Black"
                           StrokeShape="RoundRectangle 10"
                           Margin="0,5">
                                <toolkit:MediaElement 
                            x:Name="PerformVideo"
                            ShouldShowPlaybackControls="False"
                            ShouldAutoPlay="True"
                            ShouldLoopPlayback="True"
                            HeightRequest="300"
                            WidthRequest="300"
                            HorizontalOptions="Center"
                            VerticalOptions="Center"
                            Aspect="AspectFit"
                            MediaOpened="OnMediaOpened"
                            MediaFailed="OnMediaFailed"
                            MediaEnded="OnMediaEnded"
                            Volume="1"
                            IsVisible="{Binding IsSignRevealed}"/>
                            </Border>

                            <!-- Feedback Overlay in Guess Mode -->
                            <Border IsVisible="{Binding IsFeedbackVisible}"
        StrokeShape="RoundRectangle 20"
        Margin="20,0"
        VerticalOptions="Center">
                                <Border.Background>
                                    <SolidColorBrush Color="{Binding FeedbackBackgroundColor}"/>
                                </Border.Background>
                                <Label Text="{Binding FeedbackText}"
           TextColor="White"
           FontSize="24"
           FontAttributes="Bold"
           HorizontalOptions="Center"
           HorizontalTextAlignment="Center"
           Padding="20"/>
                            </Border>

                            <!-- Feedback Overlay in Perform Mode -->
                            <Border IsVisible="{Binding IsFeedbackVisible}"
        StrokeShape="RoundRectangle 20"
        Margin="20,0"
        VerticalOptions="Center">
                                <Border.Background>
                                    <SolidColorBrush Color="{Binding FeedbackBackgroundColor}"/>
                                </Border.Background>
                                <Label Text="{Binding FeedbackText}"
           TextColor="White"
           FontSize="24"
           FontAttributes="Bold"
           HorizontalOptions="Center"
           HorizontalTextAlignment="Center"
           Padding="20"/>
                            </Border>
                        </Grid>

                        <Button Text="I GOT IT RIGHT!"
                        Command="{Binding CorrectPerformCommand}"
                        Style="{StaticResource PrimaryButton}"
                        BackgroundColor="ForestGreen"
                        Margin="0,10,0,5"/>
                        <Button Text="I NEED A SIP..."
                        Command="{Binding IncorrectPerformCommand}"
                        Style="{StaticResource PrimaryButton}"
                        BackgroundColor="Crimson"
                        Margin="0,0,0,5"/>
                    </StackLayout>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>
        <!-- Game Over Screen Overlay (Sibling to Main Content) -->
        <Grid IsVisible="{Binding IsGameOver}" 
              BackgroundColor="{StaticResource GameOver}"
              InputTransparent="False" 
              ZIndex="99"
              Grid.RowSpan="3">
            <Border BackgroundColor="{StaticResource GameOver}" 
                   Margin="20" 
                   VerticalOptions="Center" 
                   HorizontalOptions="Fill" 
                   StrokeShape="RoundRectangle 20">
                <VerticalStackLayout Spacing="20" Padding="20">
                    <Label Text="Game Over!" 
                           TextColor="White" 
                           FontSize="32" 
                           FontAttributes="Bold" 
                           HorizontalOptions="Center"/>

                    <Label Text="{Binding CurrentScore, StringFormat='Final Score: {0}'}"
                           TextColor="White" 
                           FontSize="24" 
                           HorizontalOptions="Center"/>

                    <Button Text="Play Again"
                            Command="{Binding PlayAgainCommand}"
                            Style="{StaticResource PrimaryButton}"
                            BackgroundColor="White"
                            TextColor="{StaticResource GameOver}"
                            Margin="0,10,0,0"/>

                    <Button Text="Adjust Questions in Settings"
                            Command="{Binding GoToSettingsCommand}"
                            Style="{StaticResource PrimaryButton}"
                                BackgroundColor="White"
                            TextColor="{StaticResource GameOver}"
                                FontSize="14"/>
                </VerticalStackLayout>
            </Border>
        </Grid>

    </Grid>
</ContentPage>